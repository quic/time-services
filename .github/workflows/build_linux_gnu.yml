name: CI - Linux ARM64 Build

on:
  push:
    branches:
      - "main"
      - "development"
  pull_request:
    branches:
      - "**"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache QMI Framework
        id: cache-qmi
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/qmi-framework/install
          key: qmi-framework-v0.1.3-${{ runner.os }}-aarch64-linux-gnu

      - name: Install cross-compilation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      - name: Set up QEMU for ARM64
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build QMI Framework v0.1.3 in ARM64 container
        if: steps.cache-qmi.outputs.cache-hit != 'true'
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            arm64v8/ubuntu:24.04 \
            bash -c "
              apt-get update && \
              apt-get install -y git automake libtool build-essential libglib2.0-dev pkg-config && \
              git clone --branch v0.1.3 --depth 1 https://github.com/quic/qmi-framework.git qmi-framework && \
              cd qmi-framework && \
              chmod +x build_script.sh && \
              ./build_script.sh --host aarch64-linux-gnu
            "

      - name: Build time-services in ARM64 container
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            arm64v8/ubuntu:24.04 \
            bash -c "
              apt-get update && \
              apt-get install -y automake libtool build-essential libglib2.0-dev pkg-config && \
              chmod +x build_script.sh && \
              ./build_script.sh --host aarch64-linux-gnu --with_qmi_prefix /workspace/qmi-framework/install/aarch64-linux-gnu && \
              test -f install/bin/time_daemon || { echo 'Build failed: time_daemon not found'; exit 1; }
            "
